<!DOCTYPE html>
<html lang="en" style="width: 97%; background-color: #f5f5f5;">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Comatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Final Project</title>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville&display=swap" rel="stylesheet">
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js"
      charset="utf-8"
    ></script>
    <!-- Get CSS Style for muli select from file -->
    <link rel="stylesheet" href="style.css" />
    <style type="text/css">
      #radialPlots {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        margin-top: 50px;
        /* make sure the wrapped divs start at the left */
        justify-content: center;
        align-items: flex-start;

        /* width: 1920px; */

        width: 100%;
        height: 100%;

        margin-left: 20px;

        background-color: #f5f5f5;
      }

      #radialPlot1,
      #radialPlot2,
      #radialPlot3,
      #radialPlot4 {
        width: 400px; /* Adjust this value as needed */
        height: 400px;
        margin: 100px;

        /* box-sizing: border-box; Include padding and border in element's total width and height */
      }

      #radialPlot1 {
        background-color: #af1e1e;
      }

      #radialPlot2 {
        background-color: #f5f5f5;
      }

      #radialPlot3 {
        background-color: #01571f;
      }

      #radialPlot4 {
        background-color: #543ecf;
      }

      #maps {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        margin-top: 50px;
        /* make sure the wrapped divs start at the left */
        justify-content: left;
        align-items: flex-start;

        /* width: 1920px; */

        width: 67%;
        height: 100%;

        margin-left: 20px;

        background-color: #f5f5f5;
      }

      #map1,
      #map2,
      #map3,
      #map4 {
        width: 400px; /* Adjust this value as needed */
        height: 300px;
        margin: 25px;
        /* border: 3px solid black;
        border-radius: 10px;
        background-color: #cccccc; */
        margin-top: 10px;

        /* box-sizing: border-box; Include padding and border in element's total width and height */
      }

      #firstRowOfMaps,
      #secondRowOfMaps {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        margin-top: 0px;
        /* make sure the wrapped divs start at the left */
        justify-content: left;
        align-items: flex-start;

        /* width: 1920px; */

        width: 100%;
        height: 100%;

        margin-left: 20px;

        background-color: #f5f5f5;
      }

      #container {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-content: center;
        width: 103%;
      }

      #yearSelector {
        display: flex;
        flex-direction: column;
        margin-top: 4rem;
        width: 11%;
        /* font-family: sans-serif; */
      }

      #linegraph {
        margin-top: 50px;
        margin-left: 20px;
        width: 66%;
        height: 100%;
        background-color: #f5f5f5;
      }

      #textRightOfLinegraph {
        margin-left: 20px;
        font-size: 18px;
        font-weight: bold;
      }


      .h1 {
        text-align: center;
        margin: 0;
      }

      #treemap {
        margin-top: 50px;
        margin-left: 20px;
        width: 100%;
        height: 100%;
        background-color: #f5f5f5;
      }

      p {
        margin: 0;
        margin-left: 26px;
      }

      #title {
        margin-top: 50px;
        margin-left: 20px;
        width: 100%;
        height: 100%;
        background-color: #f5f5f5;
      }

      .newspaper-text {
          font-family: 'Libre Baskerville', serif;
          font-size: 45px;
          text-align: center;
      }

      .newspaper-body {
        margin-left: 130px;
        margin-right: 130px;
        font-family: 'Libre Baskerville', serif;
        font-size: 18px;
        text-align: center;
        font-weight: normal;
    }


    </style>
  </head>
  <body>

        <div id="title">
          <h1 class="newspaper-text">Greenhouse Gas Emissions Over a Decade (2010-2020)</h1>
          <h1 class="newspaper-body">Greenhouse gases are gases that absorb infrared radiation such as carbon dioxide and methane. When emitted into
            our atmosphere, these gases trap the sun's heat, leading to global warming and climate change. This article will help you to 
            understand what countries have been emitting the highest concentration of these gases, and how their emissions levels have changed
            over the last decade. We will later zoom in to focus on the United States to understand which states have the highest emissions.
          </h1>
          <svg id="linegraphSvg" width="1200" height="0"></svg>
        </div>

        <div id="linegraph">
          <h1 class="h1">How does the United States compare to other countries?</h1>
          <svg id="linegraphSvg" width="1200" height="0"></svg>
        </div>

    <div id="treemap">
      <h1 class="h1">In 2022, roughly 62% of global CO2 emissions came from those 5 countries</h1>
       <svg id="treemap" width="600" height="0"></svg>
    </div>

    <div id="radialPlots">
      <div id="radialPlot1"></div>
      <div id="radialPlot2"></div>
      <div id="radialPlot3"></div>
      <div id="radialPlot4"></div>
    </div>

    <div id="container">
      <div id="maps">
        <div id="firstRowOfMaps">
          <div id="map1OuterDiv">
            <p>CO2 (Carbon Dioxide) in Metric Tons</p>
            <div id="map1">
              <svg id="map1svg" width="300" height="300"></svg>
            </div>
          </div>

          <div id="map2OuterDiv">
            <p>CH4 (Methane) in Metric Tons</p>
            <div id="map2">
              <svg id="map2svg" width="600" height="600"></svg>
            </div>
          </div>
        </div>

        <div id="secondRowOfMaps">
          <div id="map3OuterDiv">
            <p>N2O (Nitrous Oxide) in Metric Tons</p>
            <div id="map3">
              <svg id="map3svg" width="600" height="600"></svg>
            </div>
          </div>

          <div id="map4OuterDiv">
            <p>Fluorinated Gases in Metric Tons</p>
            <div id="map4">
              <svg id="map4svg" width="600" height="600"></svg>
            </div>
          </div>
        </div>
      </div>

      <div id="yearSelector">
        <label for="multi-select" style="margin-bottom: 1rem"
          >Year Selector</label
        >
        <div class="select select--multiple">
          <select id="multi-select" multiple></select>
          <span class="focus"></span>
        </div>
        <label style="margin-top: 1rem"
          >Note: Fluorinated Gases have a disporportionately large impact on the
          environment, so a small amount has large impact.</label
        >
      </div>
    </div>

    <script type="text/javascript">
      // Set up dimensions for the map
      let width = 960;
      let height = 600;

      let yearMin = 2010;
      let yearMax = 2022;

      let multiSelect = document.getElementById("multi-select");

      for (let i = yearMin; i <= yearMax; i++) {
        let option = document.createElement("option");
        option.value = i;
        option.text = i;
        multiSelect.appendChild(option);
      }

      let numYears = 13;

      let firstTimeDrawingMap = [true, true, true, true];

      // Create an SVG element
      let svg = d3.select("#map1svg");

      // Set up projection
      let projection = d3
        .geoAlbersUsa()
        .translate([width / 100 + 200, height / 100 + 160])
        .scale(400);

      let path = d3.geoPath().projection(projection);


      // Generated using ColorBrewer with 9 colors
      let colors = [
        [
          "#ffffd9",
          "#edf8b1",
          "#c7e9b4",
          "#7fcdbb",
          "#41b6c4",
          "#1d91c0",
          "#225ea8",
          "#253494",
          "#081d58",
        ],
        [
          "#ffffe5",
          "#fff7bc",
          "#fee391",
          "#fec44f",
          "#fe9929",
          "#ec7014",
          "#cc4c02",
          "#993404",
          "#662506",
        ],
        [
          "#ffffe5",
          "#f7fcb9",
          "#d9f0a3",
          "#addd8e",
          "#78c679",
          "#41ab5d",
          "#238443",
          "#006837",
          "#004529",
        ],
        [
          "#fff7f3",
          "#fde0dd",
          "#fcc5c0",
          "#fa9fb5",
          "#f768a1",
          "#dd3497",
          "#ae017e",
          "#7a0177",
          "#49006a",
        ],
      ];

      // Define color scale
      let colorScaler = d3
        .scaleLinear()
        .domain([0, 141477787])
        .range([0, colors.length - 1]);
      // .interpolator(t => d3.interpolateViridis(1 - t)); // Reverse the interpolation

      let colorScale = function (value) {
        return colors[0][Math.floor(colorScaler(value))];
      };

      let stateTotalsByYear = [{}, {}, {}, {}];

      function drawMaps(years, stateTotalsByYearInput) {
        let aggregatedData = [];

        for (let i = 0; i < 4; i++) {
          let emissionsByState = {};

          years.forEach((year) => {
            for (const [state, data] of Object.entries(
              stateTotalsByYearInput[i]
            )) {
              if (!emissionsByState[state]) {
                emissionsByState[state] = 0;
              }
              if (data[year - 2010]) {
                emissionsByState[state] += data[year - 2010];
              }
            }
          });

          aggregatedData.push(emissionsByState);
        }

        for (let i = 0; i < 4; i++) {
          (function (i, svg) {
            if (i == 0) {
              svg = d3.select("#map1svg");
            } else if (i == 1) {
              svg = d3.select("#map2svg");
            } else if (i == 2) {
              svg = d3.select("#map3svg");
            } else {
              svg = d3.select("#map4svg");
            }

            svg.attr("width", "100%").attr("height", "100%");

            d3.json("us_states.json", function (error, us) {
              us.features.forEach(function (feature) {
                let stateName = feature.properties.NAME;
                if (aggregatedData[i][stateName]) {
                  feature.properties.emission = aggregatedData[i][stateName];
                } else {
                  feature.properties.emission = 0;
                }
              });
              //   let min = d3.min(us.features, function (d) {
              //     return d.properties.emission;
              //   });

              //   let max = d3.max(us.features, function (d) {
              //     return d.properties.emission;
              //   });

              let min = d3.min(Object.values(aggregatedData[i]));
              let max = d3.max(Object.values(aggregatedData[i]));

              console.log("MIN AND MAX");
              console.log(min, max);

              let colorScale2 = function (value) {
                return colors[i][
                  Math.floor(
                    d3
                      .scaleLinear()
                      .domain([min, max])
                      .range([0, colors[i].length - 1])(value)
                  )
                ];
              };

              if (firstTimeDrawingMap[i]) {
                firstTimeDrawingMap[i] = false;
                // Create the map based on the merged data with smooth color transitions
                svg
                  .selectAll("path")
                  .data(us.features)
                  .enter()
                  .append("path")
                  .attr("d", path)
                  .attr("class", "class" + i)
                  .style("stroke", "#000000")
                  .style("stroke-width", "1")
                  .transition() // Add transition for smooth color change
                  .duration(1) // Duration of the transition in milliseconds
                  .style("fill", function (d) {
                    let emission = d.properties.emission;
                    return emission ? colorScale2(emission) : "#f5f5f5"; // If emission value is undefined, use default color
                  });
              } else {
                // Update existing paths with smooth color transitions
                svg
                  .selectAll("path." + ("class" + i))
                  .data(us.features)
                  .transition() // Add transition for smooth color change
                  .duration(1000) // Duration of the transition in milliseconds
                  .style("fill", function (d) {
                    let emission = d.properties.emission;
                    return emission ? colorScale2(emission) : "#f5f5f5"; // If emission value is undefined, use default color
                  });
              }

              // Create an SVG element for the legend
              if (i == 0) {
            }
            d3.selectAll(".legend-rect" + i).remove();
            d3.selectAll(".legend-svg" + i).remove();
            d3.select(".legendGradient" + i).remove();
            d3.selectAll(".legend-axis" + i).remove();

              let legendSvg = svg;
              legendSvg.append("svg").attr("width", 350).attr("height", 50).attr("class", "legend-svg" + i);

              // Define legend parameters
              let legendWidth = 350;
              let legendHeight = 20;
              let numTicks = 6;

              // Create color scale legend
              let legendGradient = legendSvg
                .append("defs")
                .append("linearGradient")
                .attr("id", "legendGradient" + i)
                .attr("x1", "0%")
                .attr("y1", "0%")
                .attr("x2", "100%")
                .attr("y2", "0%");

              for (let j = 0; j <= numTicks; j++) {
                legendGradient
                  .append("stop")
                  .attr("offset", (j * 100) / numTicks + "%")
                  .attr(
                    "stop-color",
                    colorScale2((max - min) * (j / numTicks) + min)
                  )
                  .attr("stop-opacity", 1);

                console.log(colorScale2((j * max) / numTicks));
              }

              // Draw the color legend rectangle
              legendSvg
                .append("rect")
                .attr("x", 0)
                .attr("y", 0)
                .attr("width", legendWidth)
                .attr("height", legendHeight)
                .style("fill", "url(#legendGradient" + i + ")")
                .attr("class", "legend-rect" + i)
                .attr("transform", "translate(25, 20)");

              let legendScale = d3
                .scaleLinear()
                .domain([min, max])
                .range([0, legendWidth]);

              let tickValues = legendScale.ticks(numTicks);
              if (tickValues[tickValues.length - 1] !== max) {
                tickValues.push(max);
              }

              if (tickValues[0] !== min) {
                tickValues.unshift(min);
              }

              // Filter tick values to remove overlapping ticks
              tickValues = tickValues.filter((value, index) => {
                if (index === 0 || index === tickValues.length - 1) {
                  return true; // Retain the first and last tick
                }
                const currentTickPosition = legendScale(value);
                const nextTickPosition = legendScale(tickValues[index + 1]);
                return Math.abs(nextTickPosition - currentTickPosition) > 20; // Adjust the threshold as needed
              });

              // Create legend axis
              let legendAxis = d3
                .axisBottom()
                .scale(legendScale)
                .tickValues(tickValues)
                .tickFormat(d3.format(".2s"));

              // Append legend axis to SVG
              legendSvg
                .append("g")
                .attr("class", "legend-axis" + i)
                .attr("transform", "translate(25," + (legendHeight + 20) + ")")
                .call(legendAxis);
            });
          })(i, svg);
        }
      }

      async function loadData(fileLocation) {
        return new Promise((resolve, reject) => {
          d3.csv(fileLocation, (error, data) => {
            if (error) {
              reject(error);
              return;
            }

            let result = {};
            let stateFullNames = {
              AL: "Alabama",
              AK: "Alaska",
              AZ: "Arizona",
              AR: "Arkansas",
              CA: "California",
              CO: "Colorado",
              CT: "Connecticut",
              DE: "Delaware",
              FL: "Florida",
              GA: "Georgia",
              HI: "Hawaii",
              ID: "Idaho",
              IL: "Illinois",
              IN: "Indiana",
              IA: "Iowa",
              KS: "Kansas",
              KY: "Kentucky",
              LA: "Louisiana",
              ME: "Maine",
              MD: "Maryland",
              MA: "Massachusetts",
              MI: "Michigan",
              MN: "Minnesota",
              MS: "Mississippi",
              MO: "Missouri",
              MT: "Montana",
              NE: "Nebraska",
              NV: "Nevada",
              NH: "New Hampshire",
              NJ: "New Jersey",
              NM: "New Mexico",
              NY: "New York",
              NC: "North Carolina",
              ND: "North Dakota",
              OH: "Ohio",
              OK: "Oklahoma",
              OR: "Oregon",
              PA: "Pennsylvania",
              RI: "Rhode Island",
              SC: "South Carolina",
              SD: "South Dakota",
              TN: "Tennessee",
              TX: "Texas",
              UT: "Utah",
              VT: "Vermont",
              VA: "Virginia",
              WA: "Washington",
              WV: "West Virginia",
              WI: "Wisconsin",
              WY: "Wyoming",
            };

            data.forEach((d) => {
              let stateAbbreviation = d.STATE;
              let year = d.YEAR;
              let stateFullName = stateFullNames[stateAbbreviation];
              let emissionValue = parseFloat(
                d["GHG QUANTITY (METRIC TONS CO2e)"]
              );

              if (!result[stateFullName]) {
                result[stateFullName] = {};
              }

              if (result[stateFullName][year - 2010]) {
                result[stateFullName][year - 2010] += emissionValue;
              } else {
                result[stateFullName][year - 2010] = emissionValue;
              }
            });

            resolve(result);
          });
        });
      }

      async function gatherDataAndDraw() {
        try {
          let CO2dataPromise = loadData(
            "./Data Sources/CO2 Only All Years.csv"
          );
          let CH4dataPromise = loadData(
            "./Data Sources/CH4 Only All Years.csv"
          );
          let N2OdataPromise = loadData(
            "./Data Sources/N2O Only All Years.csv"
          );
          let fluorinatedGasesDataPromise = loadData(
            "./Data Sources/Fluorinated GHGs Only All Years.csv"
          );

          let [CO2data, CH4data, N2Odata, fluorinatedGasesData] =
            await Promise.all([
              CO2dataPromise,
              CH4dataPromise,
              N2OdataPromise,
              fluorinatedGasesDataPromise,
            ]);

          stateTotalsByYear[0] = CO2data;
          stateTotalsByYear[1] = CH4data;
          stateTotalsByYear[2] = N2Odata;
          stateTotalsByYear[3] = fluorinatedGasesData;

          console.log(stateTotalsByYear);

          drawMaps([2022], stateTotalsByYear);
        } catch (error) {
          console.error("Error loading data:", error);
        }
      }

      gatherDataAndDraw();

      // Add event listener to the multi-select element
      multiSelect.addEventListener("change", function () {
        let selectedYears = Array.from(this.selectedOptions).map(
          (option) => option.value
        );

        if(selectedYears.length == 0) {
          selectedYears = [2022];
        }

        drawMaps(selectedYears, stateTotalsByYear);
      });

      // BELOW IS THE CODE I ADDED FOR A RADIAL PLOT -- I think it is difficult to read, it might be better just to do a line graph or bar chart

      // Loading the csv again, this time to make a radial plot
      d3.csv("./Data Sources/CO2 Only All Years.csv", function (data) {
        const width = 600;
        const height = 700;
        const svg = d3
          .select("#radialPlot2") // Select the correct div for the radial plot
          .append("svg") // Append an SVG element
          .attr("width", width)
          .attr("height", height);

        data.forEach(function (d) {
          d["GHG QUANTITY (METRIC TONS CO2e)"] =
            +d["GHG QUANTITY (METRIC TONS CO2e)"];
        });

        // Finding the average CO2 emission value for all years, which will be the radius of the circle
        const avgCO2All = d3.mean(
          data,
          (d) => d["GHG QUANTITY (METRIC TONS CO2e)"]
        );

        // Finding the average CO2 emission for each year, which will determine how far away the lines are from the circle
        const avgCO2byYear = {};
        data.forEach(function (d) {
          const year = d.YEAR;
          if (!avgCO2byYear[year]) {
            avgCO2byYear[year] = [];
          }
          avgCO2byYear[year].push(d["GHG QUANTITY (METRIC TONS CO2e)"]);
        });

        // Actually calculating the average
        Object.keys(avgCO2byYear).forEach(function (year) {
          avgCO2byYear[year] = d3.mean(avgCO2byYear[year]);
        });

        // Defining the radius and the domain and range of values
        const radius = Math.min(width, height) / 2.5;
        const radialScale = d3
          .scaleLinear()
          .domain([
            0,
            d3.max(data, (d) => d["GHG QUANTITY (METRIC TONS CO2e)"]) * 0.02,
          ]) // I am not sure why I had to multiple by 0.02. Plot was too small at first then I tried a bunch of values
          .range([0, radius]);

        // This defines the angle for how the lines will be positioned around the circle
        const angleScale = d3
          .scaleLinear()
          .domain([0, data.length])
          .range([0, Math.PI * 2]);

        // Creating a circle representing the average CO2 emissions for all years
        svg
          .append("circle")
          .attr("cx", width / 2)
          .attr("cy", height / 2)
          .attr("r", radialScale(avgCO2All))
          .attr("fill", "#F5F5F5")
          .attr("stroke", "#D5B60A")
          .attr("stroke-width", 4);

        // Drawing lines around the circle for each year
        const line = d3
          .lineRadial()
          .radius((d, i) => radialScale(avgCO2byYear[data[i].YEAR]))
          .angle((d, i) => angleScale(i * -1)) // I made this -1 because it seems like the data was backward (2022 looked like it had greatest emissions). This needs to be looked at.
          .curve(d3.curveCardinal);

        svg
          .append("path")
          .datum(data)
          .attr("fill", "none")
          .attr("stroke", "#af1e1e")
          .attr("stroke-width", 3)
          .attr("d", line)
          .attr("transform", `translate(${width / 2}, ${height / 2})`);

        // Shades the area in between the circle and the line -- easier to see that way
        const area = d3
          .areaRadial()
          .innerRadius((d, i) => radialScale(avgCO2byYear[data[i].YEAR]))
          .outerRadius(radialScale(avgCO2All))
          .angle((d, i) => angleScale(i * -1))
          .curve(d3.curveCardinal);

        svg
          .append("path")
          .datum(data)
          .attr("fill", "#af1e1e")
          .attr("opacity", 0.5)
          .attr("d", area)
          .attr("transform", `translate(${width / 2}, ${height / 2})`);

        // Below is the code that positions the year labels around the circle. I had to use ChatGPT for major debugging of this code.
        const selectedYears = Object.keys(avgCO2byYear).filter(
          (year) => year >= 2010 && year <= 2022
        );
        const numSelectedYears = selectedYears.length;

        // Adding the labels -- some of the years overlap with the circle because label position is dependent on line position
        svg
          .selectAll(".yearLabel")
          .data(selectedYears)
          .enter()
          .append("text")
          .attr("class", "yearLabel")
          .attr("x", function (year) {
            const index = selectedYears.indexOf(year);
            const angle = (2 * Math.PI * index) / numSelectedYears;
            const labelRadius = radialScale(avgCO2byYear[year]) + 30;
            return width / 2 + labelRadius * Math.sin(angle);
          })
          .attr("y", function (year) {
            const index = selectedYears.indexOf(year);
            const angle = (2 * Math.PI * index) / numSelectedYears;
            const labelRadius = radialScale(avgCO2byYear[year]) + 30;
            return height / 2 - labelRadius * Math.cos(angle);
          })
          .text(function (year) {
            return year;
          })
          .attr("text-anchor", "middle")
          .attr("dominant-baseline", "central")
          .style("font-size", "16px")
          .style("font-weight", "bold")
          .attr("fill", "black");
      });

      // Creating a line graph of top 5 countries CO2 emissons from 2010-2022

    // Importing the data and setting the height and width
    d3.csv("./Data Sources/Our World in Data- GHG Emissions by Country.csv", function (data) {
        const margin = { top: 50, right: 240, bottom: 50, left: 130 };
        const width = 1000 - margin.left - margin.right;
        const height = 650 - margin.top - margin.bottom; // Adjusted height to fit at the top
        
        const svg = d3
            .select("#linegraph")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr(
              "transform",
              "translate(" + margin.left + "," + margin.top + ")"
            ); // Removed margin adjustment

        // x axis will be for years (2010 to 2020 only because those are the years in the data above)
        const xScale = d3.scaleLinear()
            .domain([2010, 2020])
            .range([0, width]);

        // y axis will be for ghg
        const yScale = d3.scaleLinear()
            .domain([0, 12000])
            .range([height, 0]);

          const colors = [
            "#e6b400",
            "#0e4c92",
            "#008500",
            "#c21807",
            "#7c3868",
          ];

          // creating a color scale to color the lines for each country
          const colorScale = d3
            .scaleOrdinal()
            .domain(data.map((d) => d.country))
            .range(colors);

        // lines for the graph
        const line = d3.line()
            .x(d => xScale(d.year))
            .y(d => yScale(d.total_ghg));

          // need to sort the data by year so that the line is smooth
          data.sort((a, b) => a.year - b.year);

          data.forEach((countryData) => {
            svg
              .append("path")
              .datum(data.filter((d) => d.country === countryData.country))
              .attr("fill", "none")
              .attr("stroke", colorScale(countryData.country))
              .attr("stroke-width", 3)
              .attr("d", line);
          });

          svg
            .append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(xScale).tickFormat(d3.format("d")));

          svg.append("g").call(d3.axisLeft(yScale));

          // adding x axis label
          svg
            .append("text")
            .attr("transform", `translate(${width / 2},${height + margin.top})`)
            .style("text-anchor", "middle")
            .style("font-size", "20px")
            .text("Year");

          // adding y axis label
          svg
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left + 60)
            .attr("x", 0 - height / 2)
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .style("font-size", "20px")
            .text("CO2 Emissions (Excluding Land Use)");

        // add a title
        svg.append('text')
            .attr('x', width / 2)
            .attr('y', 0 - margin.top / 2)
            .attr('text-anchor', 'middle')
            .style('font-size', '24px')
            .text('CO2 Emissions by Country (2010-2020)');

          // adding a legend
          const legend = svg
            .append("g")
            .attr("transform", `translate(${width - 10},${10})`);

          const legendItems = legend
            .selectAll(".legend")
            .data(Array.from(new Set(data.map((d) => d.country)))) // added this because countries kept repeating in the legend
            .enter()
            .append("g")
            .attr("class", "legend")
            .attr("transform", (d, i) => `translate(0,${i * 20})`);

          legendItems
            .append("rect")
            .attr("x", 115)
            .attr("width", 18)
            .attr("height", 18)
            .style("fill", (d) => colorScale(d));

          legendItems
            .append("text")
            .attr("x", 140)
            .attr("y", 9)
            .attr("dy", ".35em")
            .style("text-anchor", "start")
            .text((d) => d);

          // adding a flag to the end of each line

          // United States Flag
          const usLoc = data.find((d) => d.country === "United States");

        svg.append('image')
            .attr('href', './Flag Images/american-flag.png')
            .attr('x', xScale(usLoc.year) + 635)
            .attr('y', yScale(usLoc.total_ghg) + 5)
            .attr('width', 50)
            .attr('height', 50);


          // China Flag
          const chinaLoc = data.find((d) => d.country === "China");

        svg.append('image')
            .attr('href', './Flag Images/china-flag.png')
            .attr('x', xScale(chinaLoc.year) + 630)
            .attr('y', yScale(chinaLoc.total_ghg) - 140)
            .attr('width', 60)
            .attr('height', 60);


          // India Flag
          const indiaLoc = data.find((d) => d.country === "India");

        svg.append('image')
            .attr('href', './Flag Images/india-flag.png')
            .attr('x', xScale(indiaLoc.year) + 635)
            .attr('y', yScale(indiaLoc.total_ghg) - 57)
            .attr('width', 50)
            .attr('height', 50);


          // Russia Flag
          const russiaLoc = data.find((d) => d.country === "Russia");

        svg.append('image')
            .attr('href', './Flag Images/russia-flag.png')
            .attr('x', xScale(russiaLoc.year) + 635)
            .attr('y', yScale(russiaLoc.total_ghg) - 35)
            .attr('width', 50)
            .attr('height', 50);


          // Japan flag
          const japanLoc = data.find((d) => d.country === "Japan");

        svg.append('image')
            .attr('href', './Flag Images/japan-flag.png')
            .attr('x', xScale(japanLoc.year) + 635)
            .attr('y', yScale(japanLoc.total_ghg) - 15)
            .attr('width', 50)
            .attr('height', 50);

        // Define the positions and messages for each point
        const points = [
            { x: 400, y: 38, text: 'While other countries have seen steady decreases in greenhouse gas emissions, China is still on the rise.' },
            { x: 350, y: 286, text: 'The United States has been the country with the second highest greenhouse gas emissions in thoughout the decade 2010-2020.' },
            { x: 602, y: 300, text: 'More drastic dip due to COVID pandemic.' }
        ];

        // Append circles for the points
        svg.selectAll('.point')
            .data(points)
            .enter()
            .append('circle')
            .attr('class', 'point')
            .attr('cx', d => d.x)
            .attr('cy', d => d.y)
            .attr('r', 10) // Adjust the radius as needed
            .style('fill', '#f5f5f5')
            .style('stroke', 'black')
            .style('stroke-width', 5)
            .style('cursor', 'pointer')
        .on('mouseover', function(d) {
            const tooltipBox = svg.append('foreignObject')
                .attr('class', 'tooltip-box')
                .attr('x', d.x - 30) // Adjust the x position as needed
                .attr('y', d === points[0] ? d.y + 10 : d.y - 20)
                .attr('width', 120) // Adjust the width of the box as needed
                .attr('height', 100)
                .style('fill', 'white')
                .style('stroke', 'black')
                .style('stroke-width', 2);

            const tooltipText = svg.append('foreignObject')
                .attr('class', 'tooltip')
                .attr('x', d.x - 40) // Adjust the x position as needed
                .attr('y', d === points[0] ? d.y + 22 : d === points[1] ? d.y - 105 : d.y + 25)
                .attr('width', 250) // Adjust the width of the box as needed
                .attr('height', 100)
                .append('xhtml:div')
                .style('font-size', '18px')
                .style('text-align', 'center')
                .html(d.text);

            const textHeight = tooltipText.node().getBBox().height;

            tooltipBox.attr('height', textHeight + 20) // Adjust the height of the box based on the text height
                .attr('y', d === points[0] ? d.y + 10 : d.y - 20); // Re-adjust the y position based on the text height
        })

        .on('mouseout', function() {
            // Remove the message when mouseout
            svg.selectAll('.tooltip').remove();
            svg.selectAll('.tooltip-box').remove();
        });

    });


      // Creating a tree map to show how much of the total CO2 emissions each of these countries takes up

    // Importing the data and setting the height and width
    d3.csv("./Data Sources/Our World in Data- Grouped GHG.csv", function (data) {
        const margin = { top: 50, right: 240, bottom: 50, left: 130 };
        const width = 1000 - margin.left - margin.right;
        const height = 650 - margin.top - margin.bottom;

          const svg = d3
            .select("#treemap")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        
        // Only doing 2022 for now
        var filteredData = data.filter(function(d) {
            return d.year === "2020";
        });

          var treemap = d3.treemap().size([width, height]).padding(1);

          // Group the data by country -- onlt top 5 countries then all other countries are shown
          var nestedData = d3
            .nest()
            .key(function (d) {
              return d.country;
            })
            .entries(filteredData);

        // Creating a heirarchy for the tree map
        var root = d3.hierarchy({values: nestedData}, function(d) { return d.values; })
                    .sum(function(d) { return +d.total_ghg; });

          treemap(root);

          // creating tree map colors to correspond to the line chart

          const colors = d3
            .scaleOrdinal()
            .domain([
              "China",
              "United States",
              "India",
              "Russia",
              "Japan",
              "All Other Countries",
            ])
            .range([
              "#e6b400",
              "#0e4c92",
              "#008500",
              "#c21807",
              "#7c3868",
              "#898c8a",
            ]);

          // Making the rectangles
          svg
            .selectAll("rect")
            .data(root.leaves())
            .enter()
            .append("rect")
            .attr("x", function (d) {
              return d.x0;
            })
            .attr("y", function (d) {
              return d.y0;
            })
            .attr("width", function (d) {
              return d.x1 - d.x0;
            })
            .attr("height", function (d) {
              return d.y1 - d.y0;
            })
            .attr("fill", function (d) {
              return colors(d.data.country);
            });

        // Adding the country names
        svg.selectAll("text")
          .data(root.leaves())
          .enter()
          .append("text")
          .attr("x", function(d) { return d.x0 + 5; })
          .attr("y", function(d) { return d.y0 + 20; })
          .text(function(d) { return d.data.country; })
          .attr("fill", "white")
          .style("font-size", "20px");

        svg.append('image')
            .attr('href', './Flag Images/american-flag.png')
            .attr('x', 130)
            .attr('y', 320)
            .attr('width', 60)
            .attr('height', 60);

          svg.append('image')
            .attr('href', './Flag Images/china-flag.png')
            .attr('x', 60)
            .attr('y', -10)
            .attr('width', 70)
            .attr('height', 70);

          svg.append('image')
            .attr('href', './Flag Images/india-flag.png')
            .attr('x', 60)
            .attr('y', 460)
            .attr('width', 60)
            .attr('height', 60);

          svg.append('image')
            .attr('href', './Flag Images/russia-flag.png')
            .attr('x', 362)
            .attr('y', -5)
            .attr('width', 60)
            .attr('height', 60);

          svg.append('image')
            .attr('href', './Flag Images/japan-flag.png')
            .attr('x', 560)
            .attr('y', -5)
            .attr('width', 60)
            .attr('height', 60);

        });

    </script>
  </body>
</html>
